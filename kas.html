<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kas Sukho Nedho</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">

<h3 class="text-center">Kas Sukho Nedho</h3>

<div id="loginBox" class="col-md-4 mx-auto">
  <input id="email" class="form-control mb-2" placeholder="Email">
  <input id="password" type="password" class="form-control mb-2" placeholder="Password">
  <button class="btn btn-primary w-100" onclick="login()">Login</button>
  <button class="btn btn-link w-100" onclick="reset()">Lupa Password</button>
</div>

<div id="app" style="display:none;">
<p><b>Nama:</b> <span id="nama"></span> | <b>Role:</b> <span id="role"></span></p>
<button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>

<div id="formKas" class="mt-3">
<input id="tanggal" type="date" class="form-control mb-2">
<input id="namaTransaksi" class="form-control mb-2" placeholder="Nama Transaksi">
<select id="jenis" class="form-control mb-2">
<option>Masuk</option><option>Keluar</option>
</select>
<input id="jumlah" type="number" class="form-control mb-2" placeholder="Jumlah">
<input id="keterangan" class="form-control mb-2" placeholder="Keterangan">
<input id="foto" type="file" class="form-control mb-2">
<button class="btn btn-success" onclick="simpan()">Simpan</button>
</div>

<hr>

<select id="bulan" class="form-control mb-2">
<option value="">Bulan</option>
<option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option>
<option value="3">Apr</option><option value="4">Mei</option><option value="5">Jun</option>
<option value="6">Jul</option><option value="7">Agu</option><option value="8">Sep</option>
<option value="9">Okt</option><option value="10">Nov</option><option value="11">Des</option>
</select>
<input id="tahun" class="form-control mb-2" placeholder="Tahun">
<button class="btn btn-primary w-100" onclick="load()">Tampilkan</button>

<h5>Total: Rp <span id="total">0</span></h5>

<table class="table">
<thead><tr><th>Tgl</th><th>Nama</th><th>Jenis</th><th>Jumlah</th><th>Foto</th></tr></thead>
<tbody id="tbl"></tbody>
</table>
</div>

<script>
const API = "PASTE_URL_APPS_SCRIPT";
let user = localStorage.getItem("user");
if(user){ user=JSON.parse(user); showApp(user); }

function login(){
fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({action:"login",email:email.value,password:password.value})})
.then(r=>r.json()).then(d=>{
if(d.status==="ok"){localStorage.setItem("user",JSON.stringify({...d,email:email.value}));showApp({...d,email:email.value});}
else alert("Login gagal");
});
}

function showApp(d){
loginBox.style.display="none";
app.style.display="block";
nama.innerText=d.nama; role.innerText=d.role;
if(d.role!=="Admin") formKas.style.display="none";
user=d;
}

function reset(){
fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({action:"reset",email:email.value})})
.then(()=>alert("Password dikirim ke email"));
}

function simpan(){
const f=foto.files[0];
const r=new FileReader();
r.onload=()=>fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({
action:"simpanKas",
tanggal:tanggal.value,
nama:namaTransaksi.value,
jenis:jenis.value,
jumlah:jumlah.value,
keterangan:keterangan.value,
email:user.email,
foto:r.result.split(",")[1],
fotoType:f.type
})}).then(()=>alert("Tersimpan"));
if(f) r.readAsDataURL(f); else r.onload();
}

function load(){
fetch(`${API}?action=getKas&bulan=${bulan.value}&tahun=${tahun.value}`)
.then(r=>r.json()).then(d=>{
let t=0,h="";
d.forEach(x=>{
const j=Number(x[3]); x[2]=="Masuk"?t+=j:t-=j;
h+=`<tr><td>${x[0]}</td><td>${x[1]}</td><td>${x[2]}</td><td>${j}</td><td>${x[5]?`<a href="${x[5]}" target="_blank">Foto</a>`:""}</td></tr>`;
});
tbl.innerHTML=h; total.innerText=t;
});
}

function logout(){localStorage.clear();location.reload();}
</script>
</body>
</html>
