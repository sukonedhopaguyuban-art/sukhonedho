<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kas</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">

<h3>Kas</h3>

<div id="loginBox">
  <input id="email" class="form-control mb-2" placeholder="Email">
  <input id="password" type="password" class="form-control mb-2" placeholder="Password">
  <button class="btn btn-primary w-100" onclick="login()">Login</button>
</div>

<div id="app" style="display:none;">
  <p>Role: <b id="role"></b></p>

  <div id="formKas">
    <input id="tanggal" type="date" class="form-control mb-2">
    <input id="nama" class="form-control mb-2" placeholder="Nama Transaksi">
    <select id="jenis" class="form-control mb-2">
      <option>Masuk</option>
      <option>Keluar</option>
    </select>
    <input id="jumlah" type="number" class="form-control mb-2" placeholder="Jumlah">
    <input id="ket" class="form-control mb-2" placeholder="Keterangan">
    <button class="btn btn-success" onclick="simpan()">Simpan</button>
  </div>

  <hr>
  <h5>Total Saldo: Rp <span id="total">0</span></h5>

  <table class="table">
    <thead>
      <tr><th>Tanggal</th><th>Nama</th><th>Jenis</th><th>Jumlah</th><th>Ket</th></tr>
    </thead>
    <tbody id="tbl"></tbody>
  </table>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxMeHnXU2lhQ266OX3VeDXxVb1flg4xD2hCEHAfgR6msCQuxcZZ4tO-bWMm85a11hY5/exec";
let roleUser = "";

function login() {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "login",
      email: email.value,
      password: password.value
    })
  })
  .then(r => r.json())
  .then(d => {
    if (d.status === "ok") {
      roleUser = d.role;
      loginBox.style.display="none";
      app.style.display="block";
      role.innerText = d.role;
      load();
      if (d.role !== "admin") formKas.style.display="none";
    } else alert("Login gagal");
  });
}

function simpan() {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "addKas",
      tanggal: tanggal.value,
      nama: nama.value,
      jenis: jenis.value,
      jumlah: jumlah.value,
      keterangan: ket.value
    })
  }).then(() => load());
}

function load() {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "getKas" })
  })
  .then(r=>r.json())
  .then(rows=>{
    let t = 0, h="";
    rows.forEach(r=>{
      let j = Number(r[3]);
      r[2] === "Masuk" ? t+=j : t-=j;
      h += `<tr>
        <td>${r[0]}</td>
        <td>${r[1]}</td>
        <td>${r[2]}</td>
        <td>${j}</td>
        <td>${r[4]}</td>
      </tr>`;
    });
    tbl.innerHTML = h;
    total.innerText = t;
  });
}
</script>
</body>
</html>
