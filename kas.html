<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kas Sukho Nedho</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="container py-4">

<h2 class="text-center mb-4">Kas Sukho Nedho</h2>

<!-- LOGIN -->
<div id="loginBox" class="col-md-4 mx-auto">
  <input id="email" class="form-control mb-2" placeholder="Email">
  <input id="password" type="password" class="form-control mb-2" placeholder="Password">
  <button onclick="login()" class="btn btn-primary w-100">Login</button>
</div>

<!-- APLIKASI -->
<div id="app" style="display:none;">

  <!-- INFO USER -->
  <div class="mb-3">
    <b>Nama:</b> <span id="nama"></span><br>
    <b>Role:</b> <span id="role"></span><br>
    <button onclick="logout()" class="btn btn-danger btn-sm mt-2">Logout</button>
  </div>

  <hr>

  <!-- FORM INPUT KAS (ADMIN ONLY) -->
  <div id="formKas" class="mb-4">
    <h5>Input Kas</h5>
    <input id="tanggal" type="date" class="form-control mb-2">
    <input id="namaTransaksi" class="form-control mb-2" placeholder="Nama Transaksi">
    <select id="jenis" class="form-control mb-2">
      <option>Masuk</option>
      <option>Keluar</option>
    </select>
    <input id="jumlah" type="number" class="form-control mb-2" placeholder="Jumlah">
    <input id="keterangan" class="form-control mb-2" placeholder="Keterangan">
    <button onclick="simpanKas()" class="btn btn-success">Simpan</button>
  </div>

  <hr>

  <!-- FILTER -->
  <div class="row mb-3">
    <div class="col-md-4">
      <select id="bulan" class="form-control">
        <option value="">Pilih Bulan</option>
        <option value="0">Januari</option>
        <option value="1">Februari</option>
        <option value="2">Maret</option>
        <option value="3">April</option>
        <option value="4">Mei</option>
        <option value="5">Juni</option>
        <option value="6">Juli</option>
        <option value="7">Agustus</option>
        <option value="8">September</option>
        <option value="9">Oktober</option>
        <option value="10">November</option>
        <option value="11">Desember</option>
      </select>
    </div>
    <div class="col-md-4">
      <input id="tahun" type="number" class="form-control" placeholder="Tahun (2026)">
    </div>
    <div class="col-md-4">
      <button onclick="loadKas()" class="btn btn-primary w-100">Tampilkan</button>
    </div>
  </div>

  <!-- TOTAL -->
  <h5>Total Kas: Rp <span id="totalKas">0</span></h5>

  <!-- TABEL -->
  <table class="table table-bordered mt-3">
    <thead class="table-dark">
      <tr>
        <th>Tanggal</th>
        <th>Nama Transaksi</th>
        <th>Jenis</th>
        <th>Jumlah</th>
        <th>Keterangan</th>
      </tr>
    </thead>
    <tbody id="dataKas"></tbody>
  </table>

</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyXrDZPQoQYsJxgoAggLmEnjCFuFhj92OCuH-XiBo3iOZDE8l9cxJJ2bE1f2d0GdZ-s/exec";
let userEmail = "";

function login() {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "login",
      email: email.value,
      password: password.value
    })
  })
  .then(r => r.json())
  .then(d => {
    if (d.status === "ok") {
      userEmail = email.value;
      loginBox.style.display = "none";
      app.style.display = "block";
      nama.innerText = d.nama;
      role.innerText = d.role;
      if (d.role !== "Admin") {
        formKas.style.display = "none";
      }
    } else {
      alert("Login gagal");
    }
  });
}

function simpanKas() {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "simpanKas",
      tanggal: tanggal.value,
      nama: namaTransaksi.value,
      jenis: jenis.value,
      jumlah: jumlah.value,
      keterangan: keterangan.value,
      email: userEmail
    })
  })
  .then(() => {
    alert("Data kas tersimpan");
  });
}

function loadKas() {
  const b = bulan.value;
  const t = tahun.value;

  if (b === "" || t === "") {
    alert("Pilih bulan dan tahun");
    return;
  }

  fetch(`${API}?action=getKas&bulan=${b}&tahun=${t}`)
    .then(r => r.json())
    .then(data => {
      let html = "";
      let total = 0;

      data.forEach(d => {
        const jumlah = Number(d[3]);
        if (d[2] === "Masuk") total += jumlah;
        else total -= jumlah;

        html += `
          <tr>
            <td>${d[0]}</td>
            <td>${d[1]}</td>
            <td>${d[2]}</td>
            <td>${jumlah.toLocaleString()}</td>
            <td>${d[4]}</td>
          </tr>
        `;
      });

      dataKas.innerHTML = html;
      totalKas.innerText = total.toLocaleString();
    });
}

function logout() {
  location.reload();
}
</script>

</body>
</html>
