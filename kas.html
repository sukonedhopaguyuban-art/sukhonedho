<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kas Sukho Nedho</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">

<h3 class="text-center">Kas Sukho Nedho</h3>

<div id="loginBox" class="col-md-4 mx-auto">
  <input id="email" class="form-control mb-2" placeholder="Email">
  <input id="password" type="password" class="form-control mb-2" placeholder="Password">
  <button class="btn btn-primary w-100" onclick="login()">Login</button>
  <button class="btn btn-link w-100" onclick="resetPassword()">Lupa Password</button>
</div>

<div id="app" style="display:none;">
<p><b>Nama:</b> <span id="nama"></span> | <b>Role:</b> <span id="role"></span></p>
<button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>

<div id="formKas" class="mt-3">
<input id="tanggal" type="date" class="form-control mb-2">
<input id="namaTransaksi" class="form-control mb-2" placeholder="Nama Transaksi">
<select id="jenis" class="form-control mb-2">
<option>Masuk</option><option>Keluar</option>
</select>
<input id="jumlah" type="number" class="form-control mb-2" placeholder="Jumlah">
<input id="keterangan" class="form-control mb-2" placeholder="Keterangan">
<input id="foto" type="file" class="form-control mb-2">
<button class="btn btn-success" onclick="simpan()">Simpan</button>
</div>

<hr>

<select id="bulan" class="form-control mb-2">
<option value="">Bulan</option>
<option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option>
<option value="3">Apr</option><option value="4">Mei</option><option value="5">Jun</option>
<option value="6">Jul</option><option value="7">Agu</option><option value="8">Sep</option>
<option value="9">Okt</option><option value="10">Nov</option><option value="11">Des</option>
</select>
<input id="tahun" class="form-control mb-2" placeholder="Tahun">
<button class="btn btn-primary w-100" onclick="load()">Tampilkan</button>

<h5>Total: Rp <span id="total">0</span></h5>

<table class="table">
<thead><tr><th>Tgl</th><th>Nama</th><th>Jenis</th><th>Jumlah</th><th>Foto</th><th>Aksi</th></tr></thead>
<tbody id="tbl"></tbody>
</table>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyXrDZPQoQYsJxgoAggLmEnjCFuFhj92OCuH-XiBo3iOZDE8l9cxJJ2bE1f2d0GdZ-s/exec";
let user = null;
let editingId = null; // untuk simpan id transaksi saat edit

function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  fetch(`${API}?action=login&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`)
    .then(r => r.json())
    .then(d => {
      if (d.status === "ok") {
        alert("LOGIN BERHASIL");
        showApp(d);
      } else {
        alert("LOGIN GAGAL");
      }
    });
}

function showApp(d){
  document.getElementById("loginBox").style.display="none";
  document.getElementById("app").style.display="block";
  document.getElementById("nama").innerText=d.nama;
  document.getElementById("role").innerText=d.role;
  if(d.role !== "Admin") document.getElementById("formKas").style.display="none";
  user = d;
  load();
}

function resetPassword(){
  const email = document.getElementById("email").value;
  if(!email){ alert("Isi email dulu"); return; }

  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"reset", email})
  }).then(()=>alert("Password dikirim ke email"));
}

function simpan(){
  if(!user){ alert("Login dulu"); return; }

  const f = document.getElementById("foto").files[0];
  const r = new FileReader();
  r.onload = () => {
    let body = {
      action: editingId ? "updateKas" : "simpanKas",
      tanggal: document.getElementById("tanggal").value,
      nama: document.getElementById("namaTransaksi").value,
      jenis: document.getElementById("jenis").value,
      jumlah: document.getElementById("jumlah").value,
      keterangan: document.getElementById("keterangan").value,
      email: user.email,
      foto: f ? r.result.split(",")[1] : "",
      fotoType: f ? f.type : ""
    };
    if(editingId) body.id = editingId;

    fetch(API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    }).then(()=>{
      alert(editingId ? "Terupdate" : "Tersimpan");
      editingId = null;
      resetForm();
      load();
    });
  };
  if(f) r.readAsDataURL(f); else r.onload();
}

function load(){
  const bulan = document.getElementById("bulan").value;
  const tahun = document.getElementById("tahun").value;

  fetch(`${API}?action=getKas&bulan=${bulan}&tahun=${tahun}`)
    .then(r => r.json())
    .then(d => {
      let t = 0, h = "";
      d.forEach((x,i) => {
        const j = Number(x[3]);
        x[2]=="Masuk"?t+=j:t-=j;
        let aksi = "";
        if(user && user.role==="Admin"){
          aksi = `<button class="btn btn-sm btn-warning" onclick="edit(${i})">Edit</button>
                  <button class="btn btn-sm btn-danger" onclick="hapus(${i})">Hapus</button>`;
        }
        h += `<tr>
          <td>${x[0]}</td>
          <td>${x[1]}</td>
          <td>${x[2]}</td>
          <td>${j}</td>
          <td>${x[5]?`<a href="${x[5]}" target="_blank">Foto</a>`:""}</td>
          <td>${aksi}</td>
        </tr>`;
      });
      document.getElementById("tbl").innerHTML = h;
      document.getElementById("total").innerText = t;
      window.kasData = d; // simpan data sementara
    });
}

function edit(index){
  const x = window.kasData[index];
  editingId = index; // bisa juga simpan ID sebenarnya jika ada
  document.getElementById("tanggal").value = x[0];
  document.getElementById("namaTransaksi").value = x[1];
  document.getElementById("jenis").value = x[2];
  document.getElementById("jumlah").value = x[3];
  document.getElementById("keterangan").value = x[4];
}

function hapus(index){
  const x = window.kasData[index];
  if(!confirm("Hapus transaksi ini?")) return;
  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"hapusKas", id:index})
  }).then(()=>{alert("Terhapus"); load();});
}

function resetForm(){
  document.getElementById("tanggal").value="";
  document.getElementById("namaTransaksi").value="";
  document.getElementById("jenis").value="Masuk";
  document.getElementById("jumlah").value="";
  document.getElementById("keterangan").value="";
  document.getElementById("foto").value="";
}

function logout(){
  user = null;
  location.reload();
}
</script>
</body>
</html>
